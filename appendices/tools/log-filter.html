<!DOCTYPE html>
<html>
<head>
    <title>日志信息过滤器 - Magento 2 笔记</title>
    <base href="/" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
    <meta name="keywords" content="Magento,Magento 2,windows,常用工具,tool" />
    <meta name="description" content="记录一切与 Magento 2 使用和开发相关的内容，包括使用指南、常用代码、异常处理、运维优化等等。" />
    <link rel="shortcut icon" type="image/x-icon" href="web/images/favicon.ico" />
    <link rel="stylesheet" type="text/css" media="all" href="web/css/style.css" />
    <link rel="stylesheet" type="text/css" media="all" href="web/css/jquery.mCustomScrollbar.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="web/css/pignose.calendar.css" />
</head>
<body class="tools log-filter">
<header></header>
<style>
</style>
<main>
    <aside></aside>
    <article>
        <h1>日志信息过滤器</h1>
        <div class="log-filter-wrapper">
            <div class="toolbar">
                <div class="wrapper file-box" data-role="file-box">
                    <input type="file" class="input-file" id="log-file" />
                </div>
                <div class="wrapper input-box">
                    <input type="text" class="input-text" data-role="calendar" id="from-date" placeholder="开始日期" />
                </div>
                <div class="wrapper input-box">
                    <input type="text" class="input-text" data-role="calendar" id="to-date" placeholder="结束日期" />
                </div>
                <div class="wrapper filters-wrapper">
                    <a class="button" href="javascript:;" id="btn-filters"><span>过滤规则</span></a>
                    <div class="filters-box">
                        <div data-role="default-filters"></div>
                    </div>
                </div>
                <div class="wrapper filter">
                    <a class="button" href="javascript:;" id="btn-start-filter"><span>显示结果</span></a>
                </div>
            </div>
            <div class="content">
                <textarea class="input-text" id="content" placeholder="日志内容"></textarea>
            </div>
        </div>
    </article>
</main>
<footer></footer>
<script type="text/javascript" src="web/js/require.js"></script>
<script type="text/javascript" src="web/js/site.js"></script>
<script type="text/javascript">
    require( [ 'jquery', 'web/js/log-filter', 'web/js/pignose.calendar.full.min' ], function( $, LogFilter ) {

        let $filters = $( '[data-role="default-filters"]' );

        let strPad = function( str, length, paddingStr, paddingPos ) {
            if ( str.length >= length ) {
                return str;
            }
            let paddingStrs = '';
            for ( let i = 0; i < length - str.length; i++ ) {
                paddingStrs += paddingStr;
            }
            paddingPos = paddingPos || 'left';
            switch ( paddingPos ) {
                case 'left' :
                    return paddingStrs + str;
                case 'right' :
                    return str + paddingStrs;
            }
        };

        let logFilter = LogFilter( {
            elemId: 'log-file',
            onContentUpdate: function( sourceData ) {
                //console.log( sourceData );
            },
            onFilterUpdate: function( filteredData ) {

                let fromDate = $( '#from-date' ).val();
                fromDate = (fromDate ? (new Date( fromDate )) : (new Date( '1970-01-01' ))).getTime();

                let toDate = $( '#to-date' ).val();
                toDate = (toDate ? (new Date( toDate )) : (new Date())).getTime();

                let str = '';
                for ( let row of filteredData ) {
                    let date = (new Date( row['date'] )).getTime();
                    if ( fromDate > date || toDate < date ) {
                        continue;
                    }
                    str += '[' + row['date'] + ' ' + row['time'] + '] report.' + strPad( row['level'], 8, ' ', 'right' ) + ': ' + row['content'] + '\n';
                }
                $( '#content' ).val( str );
            }
        } );

        let builtFileBox = function() {
            let $fileBox = $( '[data-role="file-box"]' );
            let $fileInput = $fileBox.find( '[type=file]' );
            let $fileCover = $( '<a href="javascript:;"></a>' )
                .appendTo( $fileBox )
                .css( { position: 'absolute', left: 0, top: 0, height: '100%', width: '100%' } )
                .addClass( 'cover' )
                .text( '选择文件' );

            $fileBox.css( { overflow: 'hidden', position: 'relative' } );
            $fileInput.css( { height: '1px', marginTop: '1px', position: 'relative', width: '1px' } );

            $fileInput.on( 'input', function() {
                $fileCover.text( this.files[0].name );
            } );

            $fileCover.on( 'click', function() {
                $fileInput.trigger( 'click' );
            } );
        };

        let buildFilters = function() {
            for ( let i = 0; i < logFilter.defaultFilters.length; i++ ) {
                let $filter = $( '<div class="filter"></div>' )
                    .appendTo( $filters );
                $( '<a class="active" href="javascript:;"><span>' + logFilter.defaultFilters[i] + '</span></a>' )
                    .data( 'filter', logFilter.defaultFilters[i] )
                    .appendTo( $filter );
            }
            $filters.on( 'click', '.filter a', function() {
                $( this ).toggleClass( 'active' );
            } );
        };

        builtFileBox();
        buildFilters();

        $( '[data-role="calendar"]' ).pignoseCalendar( {
            format: 'YYYY-MM-DD'
        } );

        $( '#btn-filters' ).on( 'click', function() {
            $( '.filters-box' ).toggleClass( 'show' );
        } );

        $( '#log-file' ).on( 'input', logFilter.updateFileContent.bind( logFilter ) );

        $( '#btn-start-filter' ).on( 'click', function() {
            let filters = [];
            $filters.find( '.filter .active' ).each( function() {
                filters.push( $( this ).data( 'filter' ) );
            } );
            logFilter.updateFilter.apply( logFilter, [ filters ] );
        } );

    } );
</script>
</body>
</html>